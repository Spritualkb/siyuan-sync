[English](./README.md)

# 思源同步助手（SiYuan Sync）

思源同步助手通过官方内核接口打包本地数据，并将快照上传到 [123 网盘](https://www.123pan.com/)，让你轻松实现备份与恢复。插件同时支持自动备份、手动备份以及按需恢复。

## ✨ 功能特性

### 🎯 核心功能

- **多设备同步**：⭐ 新功能！通过 123 网盘实现多设备间的实时同步
  - 基于时间戳的智能双向同步
  - 四种冲突策略：保留两者/保留较新/保留本地/保留远程
  - 自动冲突检测与智能处理
  - 支持打开/关闭时自动同步
  - 同步历史跟踪，准确判断文件变化
  - 锁机制防止并发同步
  - 全面的同步范围：笔记本、模板、插件、主题、图标等
- **多种备份范围**：可按需备份工作空间、数据目录、配置目录以及开启本地加密时的 `repo` 目录
- **智能增量备份**：使用 MD5 与更新时间判断文件变化，只备份有变化的内容
- **123 网盘集成**：通过开放平台 API 上传文件，安全可靠
- **自动备份策略**：支持在关闭思源时自动备份，可配置每日触发次数
- **保留策略**：自动清理过期快照，支持按天数和数量双重限制
- **快照恢复**：可一键恢复最新快照，或选择任意历史快照进行恢复

### 🚀 用户体验

- **实时进度提示**：备份和恢复时显示详细进度对话框
  - 备份进度：准备 → 创建快照 → 上传 → 清理
  - 恢复进度：同步索引 → 下载 → 恢复
  - 显示当前处理的文件名和进度百分比
- **友好的UI界面**：直观的设置面板，清晰的状态显示
- **中英双语**：完整支持中文和英文界面

### 🔒 安全保障

- **官方 API**：所有文件操作均调用思源内核 API，避免直接操作文件系统
- **数据安全**：支持备份加密仓库（repo）数据
- **版本控制**：保留多个历史版本，随时可恢复

## 📋 使用条件

- 思源笔记版本 `≥ 3.3.0`
- 已开通 123 网盘开放平台应用（需获取 Client ID 与 Client Secret）
  - 访问 [123 网盘开放平台](https://www.123pan.com/openapi) 申请

## 🚀 快速上手

### 1. 安装插件

- 从思源笔记集市下载并启用插件
- 或手动下载 `package.zip` 到 `{工作空间}/data/plugins/` 目录

### 2. 配置 123 网盘

1. 打开插件设置
2. 填写 **Client ID** 和 **Client Secret**
3. 点击 **测试连接** 验证凭证
4. 配置 **远程备份目录** 名称（默认：SiYuanSync）

### 3. 选择备份范围

在"备份范围"中选择需要备份的内容：

- **工作空间**：同时备份数据目录和配置目录（推荐）
- **数据目录**：仅备份笔记数据
- **配置目录**：仅备份思源配置
- **加密仓库**：备份开启本地加密时的 repo 目录

### 4. 配置自动备份（可选）

- **启用自动备份**：开启后可自动执行备份
- **关闭时自动备份**：思源关闭时触发备份
- **每日自动备份上限**：限制每天自动备份次数（默认：2 次）
- **保留天数**：超过此天数的快照将被自动删除（默认：30 天）
- **最多保存快照数**：超过此数量时删除最早的快照（默认：60 个）

### 5. 配置多设备同步（新功能）⭐

在"多设备同步"部分：

1. **启用多设备同步**：开启后可在多个设备间同步数据
2. **设备名称**：为当前设备设置一个识别名称（如"办公电脑"）
3. **冲突处理策略**：
   - **保留两者**：创建冲突副本，保留两个版本
   - **保留较新**：自动保留最近修改的版本（推荐）✨
   - **保留本地**：始终保留本地版本
   - **保留远程**：始终保留云端版本
4. **自动同步选项**：
   - **打开时自动同步**：启动思源时自动同步
   - **关闭时自动同步**：关闭思源时自动同步

#### 同步范围

多设备同步功能会自动同步以下目录：

- **数据目录**：
  - `data/`: 所有笔记本和文档
  - `data/.siyuan/`: 配置文件
  - `data/plugins/`: 插件
  - `data/templates/`: 模板
  - `data/widgets/`: 挂件
  - `data/emojis/`: 自定义 Emoji
  - `data/storage/`: 存储文件（av, riff, petal）
  - `data/snippets/`: 代码片段
  
- **外观配置**：
  - `conf/appearance/themes/`: 自定义主题
  - `conf/appearance/icons/`: 自定义图标

> 💡 **提示**：内置主题和图标会被自动排除，不会同步

**首次同步：**
- 在第一个设备上点击"立即同步"，数据会上传到云端
- 在其他设备上点击"立即同步"，数据会从云端下载

**日常使用：**
- 修改数据后手动同步，或等待自动同步
- 同步完成后会显示成功消息
- 如有冲突，会根据策略自动处理并提示

### 6. 执行备份与恢复

**手动备份：**
- 点击 **立即备份** 按钮
- 查看实时进度对话框
- 备份完成后自动关闭

**恢复快照：**
- **恢复最新快照**：一键恢复最近的备份
- **选择快照恢复**：从历史快照列表中选择特定版本

## 💡 使用提示

### 备份说明

- 插件会在 123 网盘根目录下创建指定的快照文件夹
- 快照文件名格式：`{时间戳}--{类型}`，如 `20250106-123456--manual`
- `repo` 目录快照会打包为 ZIP，压缩二进制数据体积更小
- 超过 1GB 的备份会自动启用 123 网盘分片上传，无需手工处理体积限制
- 自动备份在应用关闭时尽力执行，若数据量较大，请等待上传完成

### 进度提示

- **手动操作**时显示详细进度对话框
- **自动备份**在后台静默执行，不干扰正常使用
- 进度对话框显示：
  - 当前操作步骤
  - 进度百分比
  - 正在处理的文件信息

### 多设备同步说明 ⭐

- **同步原理**：通过 123 网盘作为中转，实现多设备间的文件同步
- **同步范围**：自动同步 `data` 目录下的所有内容
- **冲突检测**：当同一文件在多个设备上都被修改时，会自动检测冲突
- **同步历史**：每个设备维护同步历史，用于判断文件的增删改状态
- **锁机制**：同一时间只允许一个设备进行同步，防止冲突
- **首次同步**：首次使用时会上传所有文件，可能需要较长时间

### 最佳实践

1. **首次使用**：建议先手动备份一次，确认配置正确
2. **多设备同步**：
   - 在每个设备上都配置相同的 Client ID 和 Client Secret
   - 为每个设备设置不同的设备名称
   - 首次同步前确保网络稳定
   - 建议选择"保留较新"的冲突策略
3. **定期检查**：在设置面板查看"远程快照数量"和"上次同步时间"
4. **恢复前确认**：恢复操作会覆盖当前数据，请谨慎操作
5. **避免冲突**：尽量不要在多个设备同时编辑同一文件

## 🛠️ 技术架构

### 核心技术

- **TypeScript** + **Webpack** + **SCSS**
- 思源笔记官方 API
- 123 网盘开放平台 API

### 主要模块

- **配置管理**：自动获取工作空间路径和系统配置
- **快照创建**：调用思源 API 导出数据和配置
- **云端同步**：通过 123 网盘 API 上传下载文件
- **备份策略**：增量备份、自动清理、保留策略
- **进度管理**：实时进度对话框，友好的用户体验
- **多设备同步** ⭐：
  - 同步管理器：协调本地和云端的文件同步
  - 冲突检测：智能识别文件冲突
  - 同步历史：跟踪设备间的同步状态
  - 锁机制：防止并发同步冲突

## 🔄 更新日志

### v2.0.0 (2025-10-27) ⭐

- ✨ **重大更新**：新增多设备同步功能
  - 基于时间戳的智能双向同步
  - 四种冲突策略：保留两者/保留较新/保留本地/保留远程
  - 自动冲突检测与智能处理
  - 同步历史跟踪（instanceId 机制）
  - 锁机制防止并发同步
  - 支持打开/关闭时自动同步
  - 全面的同步范围：
    - 所有笔记本和文档
    - 插件、模板、挂件
    - 自定义主题和图标
    - 代码片段和配置文件
- 🎨 新增多设备同步设置界面
- 📝 完善的国际化支持（中英文）
- 📚 详细的技术文档（包括实现细节和修复说明）
- 🔧 优化文件上传/下载逻辑
- 🛡️ 增强错误处理和日志记录

### v1.2.4 (2025-01-10)

- 🔧 优化上传模式，完全对齐测试脚本的成功实现
  - 添加服务器地址有效性验证
  - 统一重试等待时间为固定1秒
  - 统一错误消息格式，便于问题排查

### v0.1.0 (2025-01-06)

- ✨ 实现核心备份与恢复功能
- ✨ 支持工作空间、数据、配置、repo 多种备份范围
- ✨ 集成 123 网盘云端存储
- ✨ 自动备份策略与保留策略
- ✨ 实时进度提示对话框
- ✨ 中英双语支持
- 🎨 友好的 UI 界面设计

## 📄 许可证

AGPL-3.0 License

## 🙏 致谢

- [思源笔记](https://github.com/siyuan-note/siyuan) - 优秀的本地知识管理工具
- [123 网盘](https://www.123pan.com/) - 提供云存储服务

## 📞 反馈与支持

如有问题或建议，欢迎：
- 提交 [GitHub Issues](https://github.com/lkb/siyuan-sync/issues)
- 在思源笔记社区讨论
