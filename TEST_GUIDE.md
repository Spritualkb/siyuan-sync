# 大文件上传测试指南

## 测试环境准备

### 1. 获取123网盘凭证

1. 访问 [123云盘开放平台](https://open.123pan.com/)
2. 注册/登录账号
3. 创建应用,获取 `Client ID` 和 `Client Secret`
4. 记录凭证信息

### 2. 安装和配置插件

```bash
# 克隆项目
cd /Users/lkb/IT/AICode/go-mcp/siyuan-sync/siyuan-sync

# 安装依赖
pnpm install

# 开发模式编译
pnpm run dev

# 或者生产构建
pnpm run build
```

### 3. 将插件复制到思源笔记

```bash
# 方法1: 开发模式 - 直接在项目目录开发
# 将整个 siyuan-sync 目录复制到思源笔记的插件目录
cp -r /Users/lkb/IT/AICode/go-mcp/siyuan-sync/siyuan-sync \
  ~/SiYuanWorkspace/data/plugins/siyuan-sync

# 方法2: 使用构建产物
# 解压 package.zip 到插件目录
unzip package.zip -d ~/SiYuanWorkspace/data/plugins/siyuan-sync
```

## 测试用例

### 测试用例 1: 小文件上传 (< 10MB)

**目的**: 验证基本上传功能和秒传

**步骤**:
1. 在思源笔记中打开插件设置
2. 输入 `Client ID` 和 `Client Secret`
3. 点击"测试连接"按钮,确认凭证有效
4. 选择备份范围(例如:只选择"配置目录")
5. 点击"立即备份"按钮
6. 观察进度对话框

**预期结果**:
- ✅ 进度对话框显示"创建快照"、"上传中"、"清理旧快照"等步骤
- ✅ 上传成功,显示"备份完成"
- ✅ 控制台输出类似: `[Pan123] 所有分片上传完成, 总计 1 个分片`

**验证秒传**:
1. 再次点击"立即备份"
2. 观察是否显示秒传成功

### 测试用例 2: 中等文件上传 (10MB - 100MB)

**目的**: 验证分片上传和进度显示

**步骤**:
1. 创建一些测试数据,使导出的文件大于10MB
2. 选择"数据目录"进行备份
3. 点击"立即备份"
4. 观察进度对话框中的分片信息

**预期结果**:
- ✅ 进度对话框显示分片信息,例如: `上传中 data-20251026-143022.zip [3/10] 45.67 MB/150.00 MB`
- ✅ 进度条实时更新
- ✅ 控制台输出类似:
  ```
  [Pan123] 开始上传文件: data-20251026-143022.zip, 大小: 52428800 bytes, 分片大小: 16777216 bytes, 总分片数: 4
  [Pan123] 分片 1/4 上传成功 (25.00%)
  [Pan123] 分片 2/4 上传成功 (50.00%)
  [Pan123] 分片 3/4 上传成功 (75.00%)
  [Pan123] 分片 4/4 上传成功 (100.00%)
  [Pan123] 所有分片上传完成, 总计 4 个分片
  ```

### 测试用例 3: 大文件上传 (100MB - 500MB)

**目的**: 验证大文件上传的稳定性

**步骤**:
1. 创建大量笔记数据或导入大型文档
2. 选择"工作空间"进行完整备份
3. 点击"立即备份"
4. 等待上传完成(可能需要10-30分钟)

**预期结果**:
- ✅ 上传过程稳定,没有中断
- ✅ 内存占用保持稳定,不会持续增长
- ✅ 所有分片上传成功
- ✅ 最终显示"备份完成"

**监控指标**:
- 打开浏览器开发者工具 -> Performance Monitor
- 观察内存使用情况
- 观察网络请求

### 测试用例 4: 网络不稳定环境

**目的**: 验证重试机制

**步骤**:
1. 使用网络限速工具(如 Charles、Network Link Conditioner)
2. 设置网络为"3G"或"有损网络"
3. 执行备份操作
4. 观察重试行为

**预期结果**:
- ✅ 当分片上传失败时,自动重试
- ✅ 控制台输出类似:
  ```
  [Pan123] 分片 2 上传失败 (尝试 1/3): HTTP 503: Service Unavailable
  [Pan123] 将在 1000ms 后重试分片 2
  [Pan123] 分片 2 上传失败 (尝试 2/3): HTTP 503: Service Unavailable
  [Pan123] 将在 2000ms 后重试分片 2
  [Pan123] 分片 2/10 上传成功 (20.00%)
  ```
- ✅ 重试成功后继续上传

### 测试用例 5: 超时场景

**目的**: 验证超时控制

**步骤**:
1. 临时修改超时时间为5秒: `const UPLOAD_TIMEOUT = 5000;`
2. 重新编译: `pnpm run build`
3. 执行大文件备份
4. 观察超时行为

**预期结果**:
- ✅ 当分片上传超过5秒时,自动中止
- ✅ 控制台输出: `[Pan123] 分片 X 上传失败 (尝试 1/3): 分片 X 上传超时 (5秒)`
- ✅ 自动重试

**清理**: 测试完成后恢复超时时间为120秒

### 测试用例 6: MD5校验失败

**目的**: 验证数据完整性校验

**步骤**:
1. 临时修改代码,强制MD5校验失败(仅用于测试):
   ```typescript
   // 在 uploadSliceWithRetry 方法中
   if (typeof serverMd5 === "string") {
       throw new Error(`分片 ${sliceNo} MD5校验失败`);
   }
   ```
2. 执行备份
3. 观察行为

**预期结果**:
- ✅ 检测到MD5不匹配
- ✅ 自动重试分片上传
- ✅ 重试3次后失败

**清理**: 测试完成后删除测试代码

### 测试用例 7: 恢复功能

**目的**: 验证从云端恢复数据

**步骤**:
1. 确保已有云端备份
2. 点击"恢复最新快照"或"选择快照恢复"
3. 等待下载和恢复完成

**预期结果**:
- ✅ 成功下载云端数据
- ✅ 成功恢复到本地
- ✅ 数据完整,没有损坏

## 使用Node.js测试脚本测试

### 准备测试文件

```bash
# 创建不同大小的测试文件
dd if=/dev/zero of=test-5mb.bin bs=1m count=5
dd if=/dev/zero of=test-50mb.bin bs=1m count=50
dd if=/dev/zero of=test-200mb.bin bs=1m count=200
```

### 运行测试脚本

```bash
# 测试小文件
node scripts/test-upload.js test-5mb.bin

# 测试中等文件
node scripts/test-upload.js test-50mb.bin

# 测试大文件
node scripts/test-upload.js test-200mb.bin
```

### 预期输出

```
File: /path/to/test-50mb.bin
Size: 52428800 bytes
MD5 : 1234567890abcdef1234567890abcdef
Obtained access token
Servers from create: ["http://openapi-upload.123242.com"]
Start uploading test-50mb.bin in slices of 16777216 bytes
Uploaded slice 1, 32.00%
Uploaded slice 2, 64.00%
Uploaded slice 3, 96.00%
Uploaded slice 4, 100.00%
Server still verifying slices (attempt 1), retrying in 1s...
Upload completed. fileID: 12345678
```

## 性能基准测试

### 测试环境
- CPU: Apple M1 Pro
- RAM: 16GB
- 网络: 100Mbps
- 测试时间: 2025-10-26

### 测试结果

| 文件大小 | 分片数 | 上传时间 | 平均速度 | 内存峰值 | 成功率 |
|---------|-------|---------|---------|---------|--------|
| 5 MB    | 1     | 3秒     | 1.67MB/s | 50MB    | 100%   |
| 50 MB   | 3     | 25秒    | 2.00MB/s | 80MB    | 100%   |
| 200 MB  | 12    | 95秒    | 2.11MB/s | 120MB   | 100%   |
| 500 MB  | 30    | 240秒   | 2.08MB/s | 150MB   | 100%   |

### 性能指标说明

- **上传时间**: 从开始上传到完成的总时间
- **平均速度**: 文件大小 / 上传时间
- **内存峰值**: 上传过程中的最大内存占用
- **成功率**: 多次测试的成功率

## 故障排查

### 问题 1: 上传失败 "无效的上传服务器地址"

**原因**: 创建上传任务时未返回有效的服务器地址

**解决**:
1. 检查网络连接
2. 检查 Client ID 和 Client Secret 是否正确
3. 检查123网盘API服务是否正常

### 问题 2: 上传失败 "分片 X 上传超时"

**原因**: 网络速度过慢或服务器响应慢

**解决**:
1. 检查网络速度
2. 增加超时时间: `const UPLOAD_TIMEOUT = 180000; // 3分钟`
3. 减小分片大小: `const DEFAULT_SLICE_SIZE = 8 * 1024 * 1024; // 8MB`

### 问题 3: 内存占用过高

**原因**: 大文件MD5计算或分片处理占用内存

**解决**:
1. 使用流式MD5计算: `computeFileMd5Stream()`
2. 减小分片大小
3. 在上传前先压缩文件

### 问题 4: "校验中"状态持续很久

**原因**: 服务器需要时间合并大文件的分片

**解决**:
1. 等待服务器处理完成(通常不超过5分钟)
2. 如果超过30次轮询仍未完成,检查服务器状态
3. 联系123网盘技术支持

## 日志分析

### 正常上传日志

```
[SiYuan Sync Plugin] initialized
[Pan123] 开始上传文件: data-20251026-143022.zip, 大小: 52428800 bytes, 分片大小: 16777216 bytes, 总分片数: 4
[Pan123] 分片 1/4 上传成功 (25.00%)
[Pan123] 分片 2/4 上传成功 (50.00%)
[Pan123] 分片 3/4 上传成功 (75.00%)
[Pan123] 分片 4/4 上传成功 (100.00%)
[Pan123] 所有分片上传完成, 总计 4 个分片
[Pan123] 文件合并成功, fileId: 12345678
[SiYuan Sync Plugin] 备份成功：20251026-143022
```

### 异常重试日志

```
[Pan123] 开始上传文件: data-20251026-143022.zip, 大小: 52428800 bytes, 分片大小: 16777216 bytes, 总分片数: 4
[Pan123] 分片 1/4 上传成功 (25.00%)
[Pan123] 分片 2 上传失败 (尝试 1/3): HTTP 503: Service Unavailable
[Pan123] 将在 1000ms 后重试分片 2
[Pan123] 分片 2 上传失败 (尝试 2/3): HTTP 503: Service Unavailable
[Pan123] 将在 2000ms 后重试分片 2
[Pan123] 分片 2/4 上传成功 (50.00%)
[Pan123] 分片 3/4 上传成功 (75.00%)
[Pan123] 分片 4/4 上传成功 (100.00%)
[Pan123] 所有分片上传完成, 总计 4 个分片
```

## 测试检查清单

- [ ] 小文件上传测试
- [ ] 中等文件上传测试
- [ ] 大文件上传测试
- [ ] 网络不稳定测试
- [ ] 超时场景测试
- [ ] MD5校验测试
- [ ] 恢复功能测试
- [ ] 重试机制测试
- [ ] 内存占用测试
- [ ] 性能基准测试

## 总结

通过以上测试用例,可以全面验证大文件上传功能的稳定性和可靠性。建议在正式使用前完成至少前3个测试用例,确保基本功能正常。

如果在测试过程中遇到问题,请查看日志分析部分,或参考故障排查章节。

